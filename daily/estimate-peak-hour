#!/usr/bin/perl

@walk_scale = (
	0.156960, 0.149062, 0.120928, 0.103899,
	0.083169, 0.082922, 0.068608, 0.103406,
	0.100691, 0.061451, 0.043929, 0.036032,
	0.032083, 0.029121, 0.031589, 0.023325,
	0.023198, 0.022458, 0.037759, 0.062932,
	0.049601, 0.065086, 0.117124, 0.184464,
	0.149499, 0.207341, 0.289570, 0.353552,
	0.468401, 0.515034, 0.605510, 0.729567,
	0.686517, 0.661759, 0.719048, 0.831349,
	0.717515, 0.658215, 0.753079, 0.718400,
	0.625892, 0.578800, 0.609145, 0.713657,
	0.751217, 0.743389, 0.836444, 0.951368,
	1.054590, 1.087272, 1.141117, 1.110537,
	0.974622, 0.914492, 0.850442, 0.944396,
	0.923003, 0.916882, 0.860753, 0.838185,
	0.897903, 0.960125, 0.943387, 0.982956,
	0.987943, 0.976111, 1.066151, 1.000000,
	1.046437, 0.978166, 0.990650, 0.966968,
	0.902175, 0.901084, 0.860853, 0.805471,
	0.748748, 0.667664, 0.638205, 0.628799,
	0.632499, 0.537042, 0.493077, 0.468545,
	0.486999, 0.496476, 0.447388, 0.367436,
	0.344274, 0.321323, 0.326012, 0.276160,
	0.260365, 0.247532, 0.220632, 0.200297,
);

@drive_scale = (
	0.110546, 0.096317, 0.082176, 0.074810,
	0.071121, 0.065951, 0.059816, 0.053203,
	0.055775, 0.049363, 0.042261, 0.036840,
	0.035184, 0.034858, 0.034469, 0.034125,
	0.036111, 0.046264, 0.062852, 0.077006,
	0.095461, 0.137275, 0.242769, 0.267017,
	0.288895, 0.390020, 0.515963, 0.596758,
	0.632220, 0.754273, 0.864552, 0.917867,
	0.807001, 0.764819, 0.721796, 0.707737,
	0.617728, 0.596745, 0.594556, 0.602567,
	0.597507, 0.600615, 0.594100, 0.614942,
	0.619792, 0.646053, 0.684583, 0.715179,
	0.742712, 0.735675, 0.738540, 0.751302,
	0.733088, 0.719980, 0.736243, 0.738267,
	0.741554, 0.752630, 0.770211, 0.777499,
	0.802117, 0.828359, 0.881482, 0.872851,
	0.916243, 0.931582, 0.982489, 1.000000,
	1.073993, 1.074840, 1.016907, 0.939449,
	0.846428, 0.823735, 0.746394, 0.679338,
	0.618594, 0.599089, 0.559366, 0.524970,
	0.466027, 0.447222, 0.425046, 0.395756,
	0.390523, 0.355907, 0.326554, 0.283878,
	0.290119, 0.273774, 0.245114, 0.211466,
	0.203501, 0.179560, 0.165468, 0.130629,
);

@bike_scale = (
	0.133753, 0.122690, 0.101552, 0.089355,
	0.077145, 0.074437, 0.064212, 0.078304,
	0.078233, 0.055407, 0.043095, 0.036436,
	0.033634, 0.031990, 0.033029, 0.028725,
	0.029655, 0.034361, 0.050306, 0.069969,
	0.072531, 0.101181, 0.179946, 0.225740,
	0.219197, 0.298681, 0.402766, 0.475155,
	0.468315, 0.658879, 0.871363, 0.955590,
	0.766615, 0.977029, 1.036641, 1.074924,
	0.920732, 0.872146, 0.815830, 0.815267,
	0.753446, 0.606707, 0.747336, 0.750381,
	0.596037, 0.548780, 0.590840, 0.724505,
	0.657975, 0.689498, 0.636225, 0.610350,
	0.701674, 0.626524, 0.771689, 0.782012,
	0.724615, 0.658462, 0.619482, 0.765601,
	0.800609, 0.841463, 0.753425, 0.899543,
	0.876712, 0.969559, 0.975647, 1.000000,
	1.169466, 1.249231, 1.169466, 1.148092,
	1.085106, 0.905437, 0.844125, 0.770686,
	0.683671, 0.633376, 0.598786, 0.576884,
	0.549263, 0.492132, 0.459062, 0.432151,
	0.438761, 0.426192, 0.386971, 0.325657,
	0.317197, 0.297548, 0.285563, 0.243813,
	0.231933, 0.213546, 0.193050, 0.165463,
);


$skip = 0;

for (my $i = 0; $i <= $#walk_scale; $i++) {
	$walk_sum += $walk_scale[$i];
}
for (my $i = 0; $i <= $#walk_scale; $i++) {
	$drive_sum += $drive_scale[$i];
}
for (my $i = 0; $i <= $#walk_scale; $i++) {
	$bike_sum += $bike_scale[$i];
}

my $walk_peak = 0;
for (my $i = 0; $i + 3 <= $#walk_scale; $i++) {
	my $p = $walk_scale[$i] + $walk_scale[$i + 1] + $walk_scale[$i + 2] + $walk_scale[$i + 3];
	if ($p > $walk_peak) {
		$walk_peak = $p;
		$walk_peak_when = $i;
	}
}

my $bike_peak = 0;
for (my $i = 0; $i + 3 <= $#bike_scale; $i++) {
	my $p = $bike_scale[$i] + $bike_scale[$i + 1] + $bike_scale[$i + 2] + $bike_scale[$i + 3];
	if ($p > $bike_peak) {
		$bike_peak = $p;
		$bike_peak_when = $i;
	}
}

my $drive_peak = 0;
for (my $i = 0; $i + 3 <= $#drive_scale; $i++) {
	my $p = $drive_scale[$i] + $drive_scale[$i + 1] + $drive_scale[$i + 2] + $drive_scale[$i + 3];
	if ($p > $drive_peak) {
		$drive_peak = $p;
		$drive_peak_when = $i;

		$walk_peak = $walk_scale[$i] + $walk_scale[$i + 1] + $walk_scale[$i + 2] + $walk_scale[$i + 3];
		$bike_peak = $bike_scale[$i] + $bike_scale[$i + 1] + $bike_scale[$i + 2] + $bike_scale[$i + 3];
	}
}

$time_peak = sprintf("%02d:%02d-%02d:%02d",
	int($drive_peak_when / 4), ($drive_peak_when % 4) * 15,
	int($drive_peak_when / 4 + 1), ($drive_peak_when % 4) * 15);

if ($ARGV[0] eq "-24") {
	$walk_peak = $walk_sum;
	$bike_peak = $bike_sum;
	$drive_peak = $drive_sum;
	$time_peak = "00:00-24:00";

	shift @ARGV;
}

sub out {
	if ($count[0] != 0 && !$skip) {
		print "$okey,$time_peak,";

		for ($i = 0; $i < 20; $i++) {
			printf("%.1f,", $sum[$i] / $count[$i]);
		}

		print "$where\n";
	}
}

line:
while (<>) {
	chomp;
	($id, $name, $id2, $date, $time, @fields) = split(/,/);

	$key = "$id,$name,$id2,$date";
	$key1 = "$name,$id2,$date";

	if ($key ne $okey) {
		out();

		@sum = ();
		@count = ();
		$skip = 0;
	}

	if ($seen{"$key1,$time"}) {
		print STDERR "duplicate $key1,$time\n";
		$skip = 1;
		next;
	}
	$seen{"$key1,$time"} = 1;

	if ($time =~ /(\d+):(\d\d) *- *(\d+):(\d\d)/) {
		$n = 0;
		$dur = 0;
		$ds = 0;
		$ws = 0;
		$bs = 0;

		while ($time =~ s/(\d+):(\d\d) *- *(\d+):(\d\d)//) {
			$start = $1 * 60 + $2;
			$end = $3 * 60 + $4;

			if ($start >= 24 * 60 || $end > 24 * 60 || $start < 0 || $end - $start == 0) {
				print STDERR "Don't know what to do with time $time\n";
				next line;
			}

			if ($start < 6 * 60 && $end != 24 * 60) {
				print STDERR "Don't believe $key $time is really in the middle of the night\n";
				next line;
			}

			$dur += $end - $start;

			for ($t = $start; $t < $end; $t += 15) {
				$ds += $drive_scale[$t / 15];
				$ws += $walk_scale[$t / 15];
				$bs += $bike_scale[$t / 15];
				$n += 15;
			}
		}

		{
			for ($i = 0; $i < 12; $i++) {
				$sum[$i] += $dur * ($fields[$i] / $dur) / ($ds / $n) * $drive_peak;
				$count[$i] += $dur;
			}
			for ($i = 12; $i < 16; $i++) {
				$sum[$i] += $dur * ($fields[$i] / $dur) / ($ws / $n) * $walk_peak;
				$count[$i] += $dur;
			}
			for ($i = 16; $i < 20; $i++) {
				$sum[$i] += $dur * ($fields[$i] / $dur) / ($bs / $n) * $bike_peak;
				$count[$i] += $dur;
			}
		}
	}

	$okey = $key;
	$where = "$fields[20],$fields[21]";
}

out();
