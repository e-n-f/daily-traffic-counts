#!/usr/bin/perl

@walk_scale = (
	0.157309, 0.149394, 0.121197, 0.104131,
	0.083354, 0.083107, 0.068761, 0.103636,
	0.100915, 0.061588, 0.044027, 0.036112,
	0.032154, 0.029186, 0.031660, 0.023377,
	0.023250, 0.022508, 0.037596, 0.063072,
	0.049709, 0.064985, 0.117378, 0.184864,
	0.146606, 0.203443, 0.284195, 0.347247,
	0.469754, 0.520478, 0.606145, 0.729432,
	0.681574, 0.661623, 0.721170, 0.825908,
	0.712097, 0.657647, 0.752089, 0.716968,
	0.627401, 0.581790, 0.610030, 0.714026,
	0.751789, 0.746256, 0.845346, 0.953170,
	1.049843, 1.085941, 1.137835, 1.110014,
	0.962929, 0.905262, 0.846794, 0.932691,
	0.913410, 0.907096, 0.855271, 0.831638,
	0.899572, 0.956941, 0.946823, 0.975787,
	0.986466, 0.975520, 1.072334, 1.000000,
	1.048956, 0.979454, 0.989837, 0.967444,
	0.907522, 0.906887, 0.883237, 0.811254,
	0.729526, 0.659555, 0.628340, 0.633480,
	0.633014, 0.537560, 0.494737, 0.463876,
	0.480373, 0.488272, 0.442556, 0.362614,
	0.344546, 0.322038, 0.326738, 0.276775,
	0.260945, 0.247836, 0.221123, 0.200743,
);

@drive_scale = (
	0.113852, 0.099033, 0.084650, 0.076914,
	0.074666, 0.068524, 0.062422, 0.054958,
	0.058308, 0.051675, 0.043694, 0.038450,
	0.036639, 0.035276, 0.034977, 0.034784,
	0.037430, 0.048338, 0.065159, 0.079270,
	0.099966, 0.143333, 0.252994, 0.278000,
	0.288632, 0.390910, 0.515070, 0.596357,
	0.633458, 0.756347, 0.867613, 0.919986,
	0.808583, 0.766877, 0.724170, 0.708809,
	0.617319, 0.595955, 0.595192, 0.602367,
	0.597878, 0.601370, 0.593928, 0.615204,
	0.619312, 0.646549, 0.685871, 0.716511,
	0.743250, 0.736410, 0.739127, 0.751863,
	0.734170, 0.720506, 0.737319, 0.739556,
	0.741871, 0.752847, 0.768850, 0.776761,
	0.802082, 0.828024, 0.881999, 0.872552,
	0.916304, 0.931821, 0.983138, 1.000000,
	1.073263, 1.075448, 1.017720, 0.939123,
	0.848190, 0.822778, 0.744673, 0.675992,
	0.608094, 0.590302, 0.548751, 0.512670,
	0.455950, 0.435159, 0.410406, 0.384235,
	0.379773, 0.343150, 0.316515, 0.275938,
	0.296065, 0.280565, 0.252273, 0.216878,
	0.209956, 0.184745, 0.169777, 0.133902,
);

@bike_scale = (
	0.135580, 0.124213, 0.102924, 0.090522,
	0.079010, 0.075815, 0.065591, 0.079297,
	0.079612, 0.056632, 0.043860, 0.037281,
	0.034396, 0.032231, 0.033318, 0.029081,
	0.030340, 0.035423, 0.051378, 0.071171,
	0.074837, 0.104159, 0.185186, 0.231432,
	0.217619, 0.297177, 0.399632, 0.471802,
	0.470859, 0.656878, 0.867781, 0.949848,
	0.765337, 0.972644, 1.030303, 1.068285,
	0.913767, 0.867069, 0.811178, 0.809091,
	0.749240, 0.603631, 0.744713, 0.747734,
	0.591528, 0.549168, 0.586364, 0.719033,
	0.652968, 0.685801, 0.632931, 0.607251,
	0.700906, 0.626324, 0.768882, 0.776097,
	0.720611, 0.658015, 0.619335, 0.768882,
	0.805136, 0.844175, 0.749245, 0.895770,
	0.885196, 0.969789, 0.974320, 1.000000,
	1.166667, 1.249231, 1.160606, 1.145455,
	1.077103, 0.908879, 0.836493, 0.785047,
	0.668810, 0.624929, 0.588546, 0.573075,
	0.544482, 0.486359, 0.452571, 0.424055,
	0.430073, 0.415711, 0.379536, 0.319276,
	0.320305, 0.301302, 0.289505, 0.246826,
	0.235451, 0.216291, 0.195450, 0.167323,
);


for (my $i = 0; $i <= $#walk_scale; $i++) {
	$walk_sum += $walk_scale[$i];
}
for (my $i = 0; $i <= $#walk_scale; $i++) {
	$drive_sum += $drive_scale[$i];
}
for (my $i = 0; $i <= $#walk_scale; $i++) {
	$bike_sum += $bike_scale[$i];
}

my $walk_peak = 0;
for (my $i = 0; $i + 3 <= $#walk_scale; $i++) {
	my $p = $walk_scale[$i] + $walk_scale[$i + 1] + $walk_scale[$i + 2] + $walk_scale[$i + 3];
	if ($p > $walk_peak) {
		$walk_peak = $p;
		$walk_peak_when = $i;
	}
}

my $bike_peak = 0;
for (my $i = 0; $i + 3 <= $#bike_scale; $i++) {
	my $p = $bike_scale[$i] + $bike_scale[$i + 1] + $bike_scale[$i + 2] + $bike_scale[$i + 3];
	if ($p > $bike_peak) {
		$bike_peak = $p;
		$bike_peak_when = $i;
	}
}

my $drive_peak = 0;
for (my $i = 0; $i + 3 <= $#drive_scale; $i++) {
	my $p = $drive_scale[$i] + $drive_scale[$i + 1] + $drive_scale[$i + 2] + $drive_scale[$i + 3];
	if ($p > $drive_peak) {
		$drive_peak = $p;
		$drive_peak_when = $i;

		$walk_peak = $walk_scale[$i] + $walk_scale[$i + 1] + $walk_scale[$i + 2] + $walk_scale[$i + 3];
		$bike_peak = $bike_scale[$i] + $bike_scale[$i + 1] + $bike_scale[$i + 2] + $bike_scale[$i + 3];
	}
}

$time_peak = sprintf("%02d:%02d-%02d:%02d",
	int($drive_peak_when / 4), ($drive_peak_when % 4) * 15,
	int($drive_peak_when / 4 + 1), ($drive_peak_when % 4) * 15);

if ($ARGV[0] eq "-24") {
	$walk_peak = $walk_sum;
	$bike_peak = $bike_sum;
	$drive_peak = $drive_sum;
	$time_peak = "00:00-24:00";

	shift @ARGV;
}

sub out {
	if ($count[0] != 0) {
		print "$okey,$time_peak,";

		for ($i = 0; $i < 20; $i++) {
			printf("%.1f,", $sum[$i] / $count[$i]);
		}

		print "$where\n";
	}
}

while (<>) {
	chomp;
	($id, $name, $id2, $date, $time, @fields) = split(/,/);

	$key = "$id,$name,$id2,$date";
	if ($key ne $okey) {
		out();

		@sum = ();
		@count = ();
	}

	if ($time =~ /(\d+):(\d\d) *- *(\d+):(\d\d)/) {
		$start = $1 * 60 + $2;
		$end = $3 * 60 + $4;
		$dur = $end - $start;

		if ($start >= 24 * 60 || $end > 24 * 60 || $start < 0 || $dur == 0) {
			print STDERR "Don't know what to do with time $time\n";
			next;
		}

		if ($start < 6 * 60) {
			print STDERR "Don't believe $key $time is really in the middle of the night\n";
			next;
		}

		for ($t = $start; $t < $end; $t += 15) {
			for ($i = 0; $i < 12; $i++) {
				if ($dur == 0 || $drive_scale[$t / 15] == 0) {
					print STDERR "$_\n";
				}
				$sum[$i] += $fields[$i] * 15 / $dur * $drive_sum / $drive_scale[$t / 15] * $drive_peak / $drive_sum;
				$count[$i]++;
			}
			$n = 0;
			for ($i = 12; $i < 16; $i++) {
				$sum[$i] += $fields[$i] * 15 / $dur * $walk_sum / $walk_scale[$t / 15] * $walk_peak / $walk_sum;
				$count[$i]++;
			}

			for ($i = 16; $i < 20; $i++) {
				$sum[$i] += $fields[$i] * 15 / $dur * $bike_sum / $bike_scale[$t / 15] * $bike_peak / $bike_sum;
				$count[$i]++;
			}
		}
	}

	$okey = $key;
	$where = "$fields[20],$fields[21]";
}

out();
