#!/usr/bin/perl

@walk_scale = (
	0.157309, 0.149394, 0.121197, 0.104131,
	0.083354, 0.083107, 0.068761, 0.103636,
	0.100915, 0.061588, 0.044027, 0.036112,
	0.032154, 0.029186, 0.031660, 0.023377,
	0.023250, 0.022508, 0.037596, 0.063072,
	0.049709, 0.064985, 0.117378, 0.184864,
	0.146697, 0.203423, 0.284622, 0.347598,
	0.469987, 0.520605, 0.605048, 0.728763,
	0.682414, 0.662341, 0.721759, 0.826520,
	0.713123, 0.657464, 0.752490, 0.717059,
	0.627977, 0.581574, 0.610214, 0.714456,
	0.751933, 0.745686, 0.842997, 0.952945,
	1.051231, 1.086955, 1.138220, 1.110927,
	0.964338, 0.906045, 0.847056, 0.934316,
	0.914189, 0.907792, 0.855876, 0.831778,
	0.899472, 0.957363, 0.946803, 0.976877,
	0.986723, 0.976109, 1.071618, 1.000000,
	1.049247, 0.978581, 0.990100, 0.966897,
	0.906967, 0.907710, 0.872576, 0.813463,
	0.731544, 0.657662, 0.629285, 0.631234,
	0.633107, 0.537512, 0.493708, 0.467328,
	0.484504, 0.493947, 0.446247, 0.366344,
	0.344546, 0.322038, 0.326738, 0.276775,
	0.260945, 0.247836, 0.221123, 0.200743,
);

@drive_scale = (
	0.113852, 0.099033, 0.084650, 0.076914,
	0.074666, 0.068524, 0.062422, 0.054958,
	0.058308, 0.051675, 0.043694, 0.038450,
	0.036639, 0.035276, 0.034977, 0.034784,
	0.037430, 0.048338, 0.065159, 0.079270,
	0.099966, 0.143333, 0.252994, 0.278000,
	0.288900, 0.391047, 0.514959, 0.596485,
	0.633637, 0.756362, 0.867024, 0.919313,
	0.808203, 0.766894, 0.723955, 0.708720,
	0.617231, 0.595834, 0.594802, 0.602335,
	0.597938, 0.601435, 0.594023, 0.615064,
	0.619274, 0.646600, 0.685874, 0.716559,
	0.743437, 0.736783, 0.739395, 0.752154,
	0.734478, 0.720715, 0.737459, 0.739832,
	0.742034, 0.753125, 0.768789, 0.776674,
	0.802121, 0.828123, 0.881665, 0.872322,
	0.916072, 0.931627, 0.983103, 1.000000,
	1.073227, 1.075294, 1.017807, 0.939586,
	0.849007, 0.824137, 0.746150, 0.677613,
	0.613242, 0.594855, 0.553980, 0.518110,
	0.460768, 0.439988, 0.415448, 0.388165,
	0.384561, 0.348570, 0.320603, 0.281022,
	0.296065, 0.280565, 0.252273, 0.216878,
	0.209956, 0.184745, 0.169777, 0.133902,
);

@bike_scale = (
	0.135580, 0.124213, 0.102924, 0.090522,
	0.079010, 0.075815, 0.065591, 0.079297,
	0.079612, 0.056632, 0.043860, 0.037281,
	0.034396, 0.032231, 0.033318, 0.029081,
	0.030340, 0.035423, 0.051378, 0.071171,
	0.074837, 0.104159, 0.185186, 0.231432,
	0.217799, 0.297235, 0.399790, 0.472041,
	0.470859, 0.656878, 0.867781, 0.949848,
	0.765337, 0.972644, 1.030303, 1.068285,
	0.913767, 0.867069, 0.811178, 0.809091,
	0.749240, 0.603631, 0.744713, 0.747734,
	0.591528, 0.549168, 0.586364, 0.719033,
	0.652968, 0.685801, 0.632931, 0.607251,
	0.700906, 0.626324, 0.768882, 0.776097,
	0.720611, 0.658015, 0.619335, 0.768882,
	0.805136, 0.844175, 0.749245, 0.895770,
	0.885196, 0.969789, 0.974320, 1.000000,
	1.166667, 1.249231, 1.160606, 1.145455,
	1.077103, 0.908879, 0.836493, 0.785047,
	0.672393, 0.626259, 0.591632, 0.574672,
	0.546938, 0.488750, 0.454578, 0.427747,
	0.434532, 0.421258, 0.383425, 0.323683,
	0.320305, 0.301302, 0.289505, 0.246826,
	0.235451, 0.216291, 0.195450, 0.167323,
);


$skip = 0;

for (my $i = 0; $i <= $#walk_scale; $i++) {
	$walk_sum += $walk_scale[$i];
}
for (my $i = 0; $i <= $#walk_scale; $i++) {
	$drive_sum += $drive_scale[$i];
}
for (my $i = 0; $i <= $#walk_scale; $i++) {
	$bike_sum += $bike_scale[$i];
}

my $walk_peak = 0;
for (my $i = 0; $i + 3 <= $#walk_scale; $i++) {
	my $p = $walk_scale[$i] + $walk_scale[$i + 1] + $walk_scale[$i + 2] + $walk_scale[$i + 3];
	if ($p > $walk_peak) {
		$walk_peak = $p;
		$walk_peak_when = $i;
	}
}

my $bike_peak = 0;
for (my $i = 0; $i + 3 <= $#bike_scale; $i++) {
	my $p = $bike_scale[$i] + $bike_scale[$i + 1] + $bike_scale[$i + 2] + $bike_scale[$i + 3];
	if ($p > $bike_peak) {
		$bike_peak = $p;
		$bike_peak_when = $i;
	}
}

my $drive_peak = 0;
for (my $i = 0; $i + 3 <= $#drive_scale; $i++) {
	my $p = $drive_scale[$i] + $drive_scale[$i + 1] + $drive_scale[$i + 2] + $drive_scale[$i + 3];
	if ($p > $drive_peak) {
		$drive_peak = $p;
		$drive_peak_when = $i;

		$walk_peak = $walk_scale[$i] + $walk_scale[$i + 1] + $walk_scale[$i + 2] + $walk_scale[$i + 3];
		$bike_peak = $bike_scale[$i] + $bike_scale[$i + 1] + $bike_scale[$i + 2] + $bike_scale[$i + 3];
	}
}

$time_peak = sprintf("%02d:%02d-%02d:%02d",
	int($drive_peak_when / 4), ($drive_peak_when % 4) * 15,
	int($drive_peak_when / 4 + 1), ($drive_peak_when % 4) * 15);

if ($ARGV[0] eq "-24") {
	$walk_peak = $walk_sum;
	$bike_peak = $bike_sum;
	$drive_peak = $drive_sum;
	$time_peak = "00:00-24:00";

	shift @ARGV;
}

sub out {
	if ($count[0] != 0 && !$skip) {
		print "$okey,$time_peak,";

		for ($i = 0; $i < 20; $i++) {
			printf("%.1f,", $sum[$i] / $count[$i]);
		}

		print "$where\n";
	}
}

while (<>) {
	chomp;
	($id, $name, $id2, $date, $time, @fields) = split(/,/);

	$key = "$id,$name,$id2,$date";

	if ($key ne $okey) {
		out();

		@sum = ();
		@count = ();
		$skip = 0;
	}

	if ($seen{"$key,$time"}) {
		print STDERR "duplicate $key,$time\n";
		$skip = 1;
		next;
	}
	$seen{"$key,$time"} = 1;

	if ($time =~ /(\d+):(\d\d) *- *(\d+):(\d\d)/) {
		$start = $1 * 60 + $2;
		$end = $3 * 60 + $4;
		$dur = $end - $start;

		if ($start >= 24 * 60 || $end > 24 * 60 || $start < 0 || $dur == 0) {
			print STDERR "Don't know what to do with time $time\n";
			next;
		}

		if ($start < 6 * 60) {
			print STDERR "Don't believe $key $time is really in the middle of the night\n";
			next;
		}

		for ($t = $start; $t < $end; $t += 15) {
			for ($i = 0; $i < 12; $i++) {
				if ($dur == 0 || $drive_scale[$t / 15] == 0) {
					print STDERR "$_\n";
				}
				$sum[$i] += $fields[$i] * 15 / $dur * $drive_sum / $drive_scale[$t / 15] * $drive_peak / $drive_sum;
				$count[$i]++;
			}
			$n = 0;
			for ($i = 12; $i < 16; $i++) {
				$sum[$i] += $fields[$i] * 15 / $dur * $walk_sum / $walk_scale[$t / 15] * $walk_peak / $walk_sum;
				$count[$i]++;
			}

			for ($i = 16; $i < 20; $i++) {
				$sum[$i] += $fields[$i] * 15 / $dur * $bike_sum / $bike_scale[$t / 15] * $bike_peak / $bike_sum;
				$count[$i]++;
			}
		}
	}

	$okey = $key;
	$where = "$fields[20],$fields[21]";
}

out();
